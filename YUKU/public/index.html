<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Billing Pro V7 - Ultra Beast</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        primary: '#4f46e5', /* Indigo 600 */
                        primaryDark: '#4338ca',
                        secondary: '#64748b',
                        surface: '#ffffff',
                        background: '#f1f5f9',
                        danger: '#ef4444',
                        success: '#10b981'
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)',
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Splash Screen Animation */
        #splash { transition: opacity 0.5s ease-out, visibility 0.5s; }
        .slide-up { animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Canvas Signature */
        canvas { touch-action: none; }
        
        /* SweetAlert Custom Overrides for Tailwind Feel */
        div:where(.swal2-container) div:where(.swal2-popup) { border-radius: 1.5rem; font-family: 'Plus Jakarta Sans', sans-serif; }
        .swal2-input, .swal2-textarea { border-radius: 0.75rem !important; border: 1px solid #e2e8f0 !important; box-shadow: none !important; transition: all 0.2s; }
        .swal2-input:focus, .swal2-textarea:focus { border-color: #4f46e5 !important; ring: 2px solid #e0e7ff !important; }
    </style>
</head>

<body class="bg-background text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="splash" class="fixed inset-0 bg-primary z-[9999] flex flex-col items-center justify-center text-white">
        <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center shadow-xl mb-6 slide-up">
            <span class="material-icons-round text-5xl text-primary">receipt_long</span>
        </div>
        <h1 class="text-3xl font-bold tracking-tight slide-up" style="animation-delay: 0.1s">Billing Pro</h1>
        <p class="text-indigo-200 mt-2 font-medium slide-up" style="animation-delay: 0.2s">Enterprise V7</p>
    </div>

    <div id="overlay" onclick="toggleDrawer(false)" class="fixed inset-0 bg-slate-900/40 z-40 hidden backdrop-blur-sm transition-opacity opacity-0"></div>

    <aside id="drawer" class="fixed inset-y-0 left-0 w-72 bg-surface z-50 transform -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col lg:translate-x-0 lg:static lg:shadow-none lg:border-r border-slate-200">
        <div class="h-20 flex items-center px-8 border-b border-slate-100">
            <div class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary mr-3">
                <span class="material-icons-round text-2xl">store</span>
            </div>
            <div>
                <h2 class="font-bold text-lg leading-tight" id="sidebar-shop">My Shop</h2>
                <div class="text-xs text-slate-400 font-medium">Dashboard</div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
            <button onclick="nav('tab-store')" class="nav-item w-full flex items-center px-4 py-3.5 text-sm font-semibold rounded-xl transition-all text-slate-600 hover:bg-slate-50 hover:text-primary">
                <span class="material-icons-round text-xl mr-3 opacity-70">storefront</span> Store
            </button>
            <button onclick="nav('tab-cart')" class="nav-item w-full flex items-center px-4 py-3.5 text-sm font-semibold rounded-xl transition-all text-slate-600 hover:bg-slate-50 hover:text-primary relative">
                <span class="material-icons-round text-xl mr-3 opacity-70">shopping_cart</span> Cart
                <span id="badge-desktop" class="absolute right-4 bg-danger text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="nav('tab-items')" class="nav-item w-full flex items-center px-4 py-3.5 text-sm font-semibold rounded-xl transition-all text-slate-600 hover:bg-slate-50 hover:text-primary">
                <span class="material-icons-round text-xl mr-3 opacity-70">inventory_2</span> Inventory
            </button>
            <button onclick="nav('tab-analytics')" class="nav-item w-full flex items-center px-4 py-3.5 text-sm font-semibold rounded-xl transition-all text-slate-600 hover:bg-slate-50 hover:text-primary">
                <span class="material-icons-round text-xl mr-3 opacity-70">insights</span> Analytics
            </button>
            <button onclick="nav('tab-history')" class="nav-item w-full flex items-center px-4 py-3.5 text-sm font-semibold rounded-xl transition-all text-slate-600 hover:bg-slate-50 hover:text-primary">
                <span class="material-icons-round text-xl mr-3 opacity-70">history</span> History
            </button>
            <div class="my-4 border-t border-slate-100"></div>
            <button onclick="nav('tab-settings')" class="nav-item w-full flex items-center px-4 py-3.5 text-sm font-semibold rounded-xl transition-all text-slate-600 hover:bg-slate-50 hover:text-primary">
                <span class="material-icons-round text-xl mr-3 opacity-70">settings</span> Settings
            </button>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col h-full relative">
        
        <header class="h-16 bg-surface/90 backdrop-blur border-b border-slate-200 flex items-center justify-between px-4 lg:hidden z-30 sticky top-0">
            <button onclick="toggleDrawer(true)" class="p-2 rounded-lg text-slate-600 active:bg-slate-100">
                <span class="material-icons-round text-2xl">menu</span>
            </button>
            <span class="font-bold text-lg text-slate-800">Billing Pro</span>
            <button onclick="nav('tab-settings')" class="p-2 rounded-lg text-slate-600 active:bg-slate-100">
                <span class="material-icons-round text-2xl">settings</span>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 lg:p-8 pb-24 scroll-smooth" id="main-scroll">
            
            <div id="tab-store" class="view-section animate-fade">
                <div id="store-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 lg:gap-6">
                    </div>
            </div>

            <div id="tab-cart" class="view-section hidden animate-fade max-w-3xl mx-auto">
                <div class="bg-surface rounded-2xl shadow-card p-5 mb-4 border border-slate-100">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Customer Info</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="c-name" placeholder="Customer Name" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                        <input id="c-phone" type="number" placeholder="Phone Number" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    </div>
                    <textarea id="c-addr" rows="2" placeholder="Billing Address" class="w-full mt-4 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition resize-none"></textarea>
                </div>

                <div id="manual-btn-area" class="mb-4">
                    <button onclick="openManualAdd()" class="w-full py-3.5 border-2 border-dashed border-primary/30 rounded-2xl text-primary font-bold text-sm hover:bg-primary/5 active:bg-primary/10 transition flex items-center justify-center gap-2">
                        <span class="material-icons-round">add_circle</span> Add Custom Item
                    </button>
                </div>

                <div id="cart-list" class="space-y-3 pb-24"></div>

                <div id="checkout-bar" class="fixed bottom-20 lg:bottom-8 left-4 right-4 lg:left-auto lg:right-8 lg:w-96 bg-slate-900 text-white p-4 rounded-2xl shadow-xl z-30 flex items-center justify-between hidden">
                    <div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Total Payable</div>
                        <div class="text-xl font-bold">₹<span id="cart-total">0.00</span></div>
                    </div>
                    <button onclick="generateBill()" class="bg-white text-slate-900 px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-100 active:scale-95 transition flex items-center gap-2 shadow-lg">
                        Checkout <span class="material-icons-round text-base">arrow_forward</span>
                    </button>
                </div>
            </div>

            <div id="tab-items" class="view-section hidden animate-fade">
                <div class="flex gap-3 mb-6 sticky top-0 bg-background/95 backdrop-blur z-20 py-2">
                    <div class="relative flex-1">
                        <span class="material-icons-round absolute left-3.5 top-3.5 text-slate-400">search</span>
                        <input id="inv-search" oninput="renderInventory()" type="text" placeholder="Search products..." class="w-full pl-11 pr-4 py-3 bg-surface border-none shadow-soft rounded-xl text-sm focus:ring-2 focus:ring-primary transition">
                    </div>
                    <button onclick="openItemModal()" class="w-12 h-12 flex items-center justify-center bg-primary text-white rounded-xl shadow-lg shadow-primary/30 hover:bg-primaryDark active:scale-95 transition">
                        <span class="material-icons-round">add</span>
                    </button>
                </div>
                <div id="inv-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <div id="tab-analytics" class="view-section hidden animate-fade max-w-4xl mx-auto">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-surface p-5 rounded-2xl shadow-card">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Revenue</div>
                        <div class="text-2xl font-bold text-slate-800 mt-1" id="an-rev">₹0</div>
                    </div>
                    <div class="bg-surface p-5 rounded-2xl shadow-card">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Cost</div>
                        <div class="text-2xl font-bold text-slate-500 mt-1" id="an-cost">₹0</div>
                    </div>
                    <div class="col-span-2 bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl text-white shadow-lg shadow-emerald-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-xs font-bold text-emerald-100 uppercase tracking-widest">Net Profit</div>
                                <div class="text-4xl font-extrabold mt-1" id="an-profit">₹0</div>
                            </div>
                            <div class="bg-white/20 backdrop-blur px-3 py-1 rounded-lg text-xs font-bold">
                                Margin: <span id="an-margin">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-surface rounded-2xl shadow-card p-6">
                    <h3 class="text-sm font-bold text-slate-800 mb-4">Stock Valuation</h3>
                    <div class="flex justify-between py-3 border-b border-slate-50">
                        <span class="text-sm text-slate-500">Asset Value (Cost)</span>
                        <span class="font-bold text-slate-800" id="an-asset">₹0</span>
                    </div>
                    <div class="flex justify-between py-3">
                        <span class="text-sm text-slate-500">Potential Sales</span>
                        <span class="font-bold text-slate-800" id="an-pot">₹0</span>
                    </div>
                </div>
            </div>

            <div id="tab-history" class="view-section hidden animate-fade">
                <div class="flex p-1 bg-slate-200/50 rounded-xl mb-6">
                    <button onclick="toggleHist('all')" id="btn-h-all" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white shadow-sm text-primary">All Bills</button>
                    <button onclick="toggleHist('club')" id="btn-h-club" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-500 hover:bg-white/50">By Customer</button>
                </div>
                <input id="hist-search" oninput="renderHistory()" type="text" placeholder="Search History..." class="w-full mb-4 px-4 py-3 bg-surface border-none shadow-soft rounded-xl text-sm focus:ring-2 focus:ring-primary transition">
                <div id="hist-list" class="space-y-3"></div>
                
                <div class="mt-8 text-center">
                    <button onclick="resetApp()" class="text-xs font-bold text-danger border border-danger/20 px-4 py-2 rounded-lg hover:bg-danger/5 transition">Reset Data</button>
                </div>
            </div>

            <div id="tab-settings" class="view-section hidden animate-fade max-w-md mx-auto text-center">
                <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-primary">
                    <span class="material-icons-round text-4xl">store</span>
                </div>
                <h2 class="text-xl font-bold">Settings</h2>
                <p class="text-sm text-slate-500 mb-8">Customize your experience</p>

                <div class="space-y-3 text-left">
                    <div class="bg-surface p-4 rounded-2xl shadow-card flex items-center justify-between">
                        <span class="text-sm font-bold text-slate-700">Show Manual Add Button</span>
                        <div onclick="toggleManualBtn()" id="tog-man" class="w-11 h-6 bg-primary rounded-full relative cursor-pointer transition-colors">
                            <div class="w-4 h-4 bg-white rounded-full absolute top-1 right-1 transition-all shadow-sm"></div>
                        </div>
                    </div>
                    
                    <button onclick="editShopDetails()" class="w-full bg-surface p-4 rounded-2xl shadow-card flex items-center justify-between hover:bg-slate-50 transition group">
                        <span class="text-sm font-bold text-slate-700">Business Details</span>
                        <span class="material-icons-round text-slate-300 group-hover:text-primary transition">chevron_right</span>
                    </button>

                    <button onclick="openSignature()" class="w-full bg-surface p-4 rounded-2xl shadow-card flex items-center justify-between hover:bg-slate-50 transition group">
                        <span class="text-sm font-bold text-slate-700">Digital Signature</span>
                        <span class="material-icons-round text-slate-300 group-hover:text-primary transition">chevron_right</span>
                    </button>

                    <button onclick="startTour()" class="w-full bg-surface p-4 rounded-2xl shadow-card flex items-center justify-between hover:bg-slate-50 transition group">
                        <span class="text-sm font-bold text-slate-700">Replay Tutorial</span>
                        <span class="material-icons-round text-slate-300 group-hover:text-primary transition">help_outline</span>
                    </button>
                </div>
            </div>

        </main>

        <nav class="lg:hidden fixed bottom-0 w-full bg-surface/90 backdrop-blur-lg border-t border-slate-200 flex justify-around py-1 pb-[env(safe-area-inset-bottom)] z-40">
            <button onclick="nav('tab-store')" class="nav-mobile p-2 text-slate-400 hover:text-primary flex flex-col items-center">
                <span class="material-icons-round text-2xl mb-0.5">storefront</span>
                <span class="text-[10px] font-medium">Store</span>
            </button>
            <button onclick="nav('tab-cart')" class="nav-mobile p-2 text-slate-400 hover:text-primary flex flex-col items-center relative">
                <span class="material-icons-round text-2xl mb-0.5">shopping_cart</span>
                <span class="text-[10px] font-medium">Cart</span>
                <span id="badge-mobile" class="absolute top-1 right-3 bg-danger text-white text-[9px] font-bold w-4 h-4 flex items-center justify-center rounded-full hidden">0</span>
            </button>
            <button onclick="nav('tab-items')" class="nav-mobile p-2 text-slate-400 hover:text-primary flex flex-col items-center">
                <span class="material-icons-round text-2xl mb-0.5">inventory_2</span>
                <span class="text-[10px] font-medium">Items</span>
            </button>
            <button onclick="nav('tab-history')" class="nav-mobile p-2 text-slate-400 hover:text-primary flex flex-col items-center">
                <span class="material-icons-round text-2xl mb-0.5">history</span>
                <span class="text-[10px] font-medium">History</span>
            </button>
        </nav>

    </div>

    <div id="preview-modal" class="fixed inset-0 z-[60] bg-background hidden flex flex-col">
        <div class="h-16 bg-surface border-b border-slate-200 flex items-center justify-between px-4 shrink-0">
            <button onclick="closePreview()" class="flex items-center text-sm font-bold text-slate-600 hover:text-primary">
                <span class="material-icons-round mr-1">arrow_back</span> Back
            </button>
            <span class="font-bold text-slate-800">Invoice Preview</span>
            <div class="w-10"></div> </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            <div id="invoice-paper" class="bg-white max-w-xl mx-auto p-6 md:p-10 shadow-xl rounded-sm text-slate-800 text-xs md:text-sm leading-relaxed relative">
                
                <div class="flex justify-between items-start border-b border-slate-100 pb-6 mb-6">
                    <div>
                        <h1 id="inv-shop" class="text-xl font-extrabold text-primary uppercase tracking-tight">Shop Name</h1>
                        <p id="inv-addr" class="text-slate-500 mt-1 whitespace-pre-line">Address</p>
                    </div>
                    <div class="text-right">
                        <div class="text-slate-400 font-bold text-[10px] uppercase tracking-wider">Invoice #</div>
                        <div class="text-lg font-bold" id="inv-id">1001</div>
                        <div class="text-slate-500 mt-1" id="inv-date">--/--/--</div>
                    </div>
                </div>

                <div class="bg-slate-50 p-4 rounded-lg mb-6 border border-slate-100">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Bill To</div>
                    <div class="font-bold text-base text-slate-800" id="inv-client">Client Name</div>
                    <div class="text-slate-500" id="inv-client-addr">Address</div>
                </div>

                <table class="w-full mb-8">
                    <thead>
                        <tr class="border-b-2 border-slate-100">
                            <th class="text-left py-2 font-bold text-slate-500 w-1/2">Item</th>
                            <th class="text-center py-2 font-bold text-slate-500">Qty</th>
                            <th class="text-right py-2 font-bold text-slate-500">Price</th>
                            <th class="text-right py-2 font-bold text-slate-500">Total</th>
                        </tr>
                    </thead>
                    <tbody id="inv-body" class="divide-y divide-slate-50"></tbody>
                </table>

                <div class="flex justify-end border-t-2 border-slate-800 pt-4 mb-8">
                    <div class="text-right">
                        <div class="text-2xl font-extrabold text-slate-900">Total: ₹<span id="inv-total">0.00</span></div>
                    </div>
                </div>

                <div class="flex justify-between items-end">
                    <div class="w-1/2">
                        <div class="text-[10px] font-bold text-slate-400 uppercase">Notes</div>
                        <p id="inv-note" class="text-slate-500 italic mt-1">Thank you.</p>
                    </div>
                    <div class="text-center">
                        <div id="inv-sign" class="h-12 flex items-end justify-center mb-1"></div>
                        <div class="border-t border-slate-300 w-32 mx-auto pt-1 text-[10px] font-bold text-slate-400 uppercase">Authorized Signatory</div>
                    </div>
                </div>
            </div>
            
            <div id="inv-actions-new" class="max-w-xl mx-auto grid grid-cols-2 gap-4 mt-6 pb-10">
                <button onclick="finishBill(false)" class="py-3.5 rounded-xl border font-bold text-slate-600 bg-white hover:bg-slate-50">Save Only</button>
                <button onclick="finishBill(true)" class="py-3.5 rounded-xl bg-primary text-white font-bold shadow-lg shadow-primary/30 hover:bg-primaryDark">Save & Download</button>
            </div>
            <div id="inv-actions-hist" class="max-w-xl mx-auto mt-6 pb-10 hidden">
                 <button onclick="downloadInvoice()" class="w-full py-3.5 rounded-xl bg-primary text-white font-bold shadow-lg">Download Image</button>
            </div>
        </div>
    </div>

    <script>
        // --- CORE STATE ---
        const app = {
            data: {
                inv: JSON.parse(localStorage.getItem('bp7_inv')) || [],
                hist: JSON.parse(localStorage.getItem('bp7_hist')) || [],
                cart: [],
                count: parseInt(localStorage.getItem('bp7_cnt')) || 1001,
                sets: JSON.parse(localStorage.getItem('bp7_sets')) || {
                    name: 'My Shop', addr: 'New Delhi, India', note: 'Thank you for your business.',
                    sign: null, showMan: true, tourDone: false
                }
            },
            ui: { tab: 'tab-store', imgs: [] }
        };

        // --- INIT ---
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                document.getElementById('splash').style.visibility = 'hidden';
                if(!app.data.sets.tourDone) startTour();
            }, 2000); // 2 sec splash
            renderAll();
            updateSettingsUI();
        };

        function save() {
            localStorage.setItem('bp7_inv', JSON.stringify(app.data.inv));
            localStorage.setItem('bp7_hist', JSON.stringify(app.data.hist));
            localStorage.setItem('bp7_cnt', app.data.count);
            localStorage.setItem('bp7_sets', JSON.stringify(app.data.sets));
            renderAll();
        }

        // --- NAVIGATION ---
        function nav(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
            
            // Sidebar Styling
            document.querySelectorAll('.nav-item').forEach(b => {
                b.classList.remove('bg-slate-50', 'text-primary');
                b.classList.add('text-slate-600');
            });
            // Mobile Nav Styling
            document.querySelectorAll('.nav-mobile').forEach(b => b.classList.remove('text-primary'));
            
            // Highlight Active
            const idx = ['tab-store','tab-cart','tab-items','tab-analytics','tab-history','tab-settings'].indexOf(id);
            if(idx > -1) {
                if(document.querySelectorAll('.nav-item')[idx]) {
                    document.querySelectorAll('.nav-item')[idx].classList.add('bg-slate-50', 'text-primary');
                    document.querySelectorAll('.nav-item')[idx].classList.remove('text-slate-600');
                }
                if(document.querySelectorAll('.nav-mobile')[idx]) {
                    document.querySelectorAll('.nav-mobile')[idx].classList.add('text-primary');
                }
            }
            toggleDrawer(false);
        }

        function toggleDrawer(show) {
            const d = document.getElementById('drawer');
            const o = document.getElementById('overlay');
            if(show) { d.classList.remove('-translate-x-full'); o.classList.remove('hidden'); setTimeout(()=>o.classList.remove('opacity-0'),10); }
            else { d.classList.add('-translate-x-full'); o.classList.add('opacity-0'); setTimeout(()=>o.classList.add('hidden'),300); }
        }

        function renderAll() {
            renderStore(); renderCart(); renderInv(); renderAnalytics(); renderHist();
        }

        // --- STORE ---
        function renderStore() {
            const grid = document.getElementById('store-grid');
            if(app.data.inv.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400"><span class="material-icons-round text-5xl mb-2 opacity-50">store_mall_directory</span><p>Inventory Empty</p></div>`;
                return;
            }
            grid.innerHTML = app.data.inv.map((item, idx) => {
                const inCart = app.data.cart.find(c => c.id === item.id);
                const img = item.imgs[0] ? `<img src="${item.imgs[0]}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">` : `<div class="w-full h-full bg-slate-100 flex items-center justify-center text-slate-300"><span class="material-icons-round text-4xl">image</span></div>`;
                
                const btn = inCart 
                    ? `<div class="flex items-center bg-slate-800 text-white rounded-lg p-1 w-full justify-between"><button onclick="modCart('${item.id}',-1)" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded">-</button><span class="font-bold text-sm">${inCart.qty}</span><button onclick="modCart('${item.id}',1)" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded">+</button></div>`
                    : `<button onclick="addCart(${idx})" class="w-full py-2.5 bg-primary/10 text-primary font-bold text-sm rounded-lg hover:bg-primary hover:text-white transition">Add to Cart</button>`;

                return `
                <div class="bg-surface rounded-2xl shadow-card border border-slate-100 overflow-hidden group relative flex flex-col h-full hover:shadow-soft transition-all">
                    <button onclick="opts(${idx}, 'inv')" class="absolute top-2 right-2 w-8 h-8 bg-white/90 backdrop-blur rounded-full flex items-center justify-center shadow-sm text-slate-600 z-10"><span class="material-icons-round text-base">more_vert</span></button>
                    <div class="aspect-square relative overflow-hidden">${img}</div>
                    <div class="p-4 flex flex-col justify-between flex-1">
                        <div><h3 class="font-bold text-slate-800 text-sm leading-tight line-clamp-2">${item.name}</h3><div class="text-xs text-slate-400 mt-1">Stock: ${item.stock}</div></div>
                        <div class="mt-4"><div class="font-extrabold text-slate-900 mb-3 text-lg">₹${item.price}</div>${btn}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- CART ---
        function addCart(idx) {
            const i = app.data.inv[idx];
            app.data.cart.push({ id: i.id, name: i.name, price: i.price, cost: i.cost, qty: 1, imgs: i.imgs });
            save(); toast('Added to Cart');
        }

        function modCart(id, d) {
            const c = app.data.cart.find(x => x.id === id);
            if(c) { c.qty += d; if(c.qty <= 0) app.data.cart = app.data.cart.filter(x => x.id !== id); save(); }
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            const totalEl = document.getElementById('cart-total');
            const bar = document.getElementById('checkout-bar');
            let tot = 0, cnt = 0;

            if(app.data.cart.length === 0) {
                list.innerHTML = `<div class="text-center py-10 opacity-40"><span class="material-icons-round text-6xl">shopping_cart_checkout</span><p>Empty Cart</p></div>`;
                bar.classList.add('hidden');
            } else {
                bar.classList.remove('hidden');
                list.innerHTML = app.data.cart.map(c => {
                    tot += c.price * c.qty; cnt += c.qty;
                    const img = c.imgs && c.imgs[0] ? `<img src="${c.imgs[0]}" class="w-12 h-12 rounded-lg object-cover">` : `<div class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center"><span class="material-icons-round text-slate-400 text-sm">edit</span></div>`;
                    return `
                    <div class="flex items-center gap-3 bg-surface p-3 rounded-2xl border border-slate-100 shadow-sm">
                        ${img}
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-sm text-slate-800 truncate">${c.name}</div>
                            <div class="text-xs text-slate-400 line-clamp-1">${c.desc||''}</div>
                            <div class="text-xs font-bold text-primary">₹${c.price}</div>
                        </div>
                        <div class="flex items-center gap-2 bg-slate-50 rounded-lg p-1">
                            <button onclick="modCart('${c.id}',-1)" class="w-7 h-7 flex items-center justify-center bg-white shadow rounded text-slate-600">-</button>
                            <span class="text-xs font-bold w-4 text-center">${c.qty}</span>
                            <button onclick="modCart('${c.id}',1)" class="w-7 h-7 flex items-center justify-center bg-white shadow rounded text-slate-600">+</button>
                        </div>
                    </div>`;
                }).join('');
            }
            totalEl.innerText = tot.toFixed(2);
            document.getElementById('badge-desktop').innerText = cnt;
            document.getElementById('badge-mobile').innerText = cnt;
            document.getElementById('badge-desktop').classList.toggle('hidden', cnt===0);
            document.getElementById('badge-mobile').classList.toggle('hidden', cnt===0);
        }

        function openManualAdd() {
            app.ui.imgs = [];
            Swal.fire({
                title: 'Add Manual Item',
                html: `
                <div class="space-y-3">
                    <div onclick="document.getElementById('m-file').click()" class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer hover:bg-slate-50">
                        <span class="material-icons-round text-3xl text-slate-300">add_photo_alternate</span>
                        <p class="text-xs text-slate-400 font-bold mt-1">Add Images (Max 5)</p>
                    </div>
                    <input type="file" id="m-file" hidden multiple accept="image/*" onchange="handleImg(this)">
                    <div id="swal-img-prev" class="flex gap-2 overflow-x-auto h-16 no-scrollbar"></div>
                    <input id="m-n" class="swal2-input w-full" placeholder="Item Name">
                    <textarea id="m-d" class="swal2-textarea w-full" placeholder="Description" rows="1"></textarea>
                    <div class="grid grid-cols-2 gap-3"><input id="m-p" type="number" class="swal2-input" placeholder="Price"><input id="m-c" type="number" class="swal2-input" placeholder="Cost"></div>
                </div>`,
                confirmButtonColor: '#4f46e5', confirmButtonText: 'Add', showCancelButton: true,
                preConfirm: () => {
                    const n = document.getElementById('m-n').value, p = document.getElementById('m-p').value;
                    if(!n || !p) return Swal.showValidationMessage('Name & Price required');
                    return { id: 'm_'+Date.now(), name: n, desc: document.getElementById('m-d').value, price: parseFloat(p), cost: parseFloat(document.getElementById('m-c').value)||0, qty: 1, imgs: [...app.ui.imgs], isManual: true };
                }
            }).then(r => { if(r.isConfirmed) { app.data.cart.push(r.value); save(); } });
        }

        // --- INVENTORY ---
        function renderInv() {
            const list = document.getElementById('inv-list');
            const term = document.getElementById('inv-search').value.toLowerCase();
            const filtered = app.data.inv.filter(i => i.name.toLowerCase().includes(term));
            
            if(filtered.length === 0) { list.innerHTML = `<div class="col-span-full text-center py-10 opacity-50">No Items Found</div>`; return; }

            list.innerHTML = filtered.map((item) => {
                const idx = app.data.inv.indexOf(item);
                const img = item.imgs[0] ? `<img src="${item.imgs[0]}" class="w-12 h-12 rounded bg-slate-100 object-cover">` : `<div class="w-12 h-12 bg-slate-100 rounded flex items-center justify-center text-slate-300"><span class="material-icons-round">image</span></div>`;
                return `
                <div class="bg-surface p-3 rounded-xl border border-slate-100 shadow-sm flex items-center gap-3 relative hover:shadow-md transition">
                    <button onclick="opts(${idx}, 'inv')" class="absolute top-2 right-2 text-slate-400 hover:text-slate-800"><span class="material-icons-round">more_vert</span></button>
                    ${img}
                    <div>
                        <div class="font-bold text-sm text-slate-800">${item.name}</div>
                        <div class="text-xs text-slate-500">Stock: ${item.stock} | Cost: ${item.cost}</div>
                        <div class="text-sm font-bold text-primary">₹${item.price}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function openItemModal(idx = null) {
            const isEdit = idx !== null;
            const i = isEdit ? app.data.inv[idx] : { name:'', price:'', cost:'', stock:'', imgs:[] };
            app.ui.imgs = [...i.imgs];
            Swal.fire({
                title: isEdit ? 'Edit Item' : 'New Item',
                html: `
                <div class="space-y-3">
                    <div onclick="document.getElementById('i-file').click()" class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer hover:bg-slate-50">
                         <span class="material-icons-round text-3xl text-slate-300">collections</span>
                         <p class="text-xs text-slate-400 font-bold mt-1">Images (Max 5)</p>
                    </div>
                    <input type="file" id="i-file" hidden multiple accept="image/*" onchange="handleImg(this)">
                    <div id="swal-img-prev" class="flex gap-2 overflow-x-auto h-16 no-scrollbar"></div>
                    <input id="i-n" class="swal2-input w-full" placeholder="Name" value="${i.name}">
                    <div class="grid grid-cols-2 gap-3"><input id="i-p" type="number" class="swal2-input" placeholder="Price" value="${i.price}"><input id="i-c" type="number" class="swal2-input" placeholder="Cost" value="${i.cost}"></div>
                    <input id="i-s" type="number" class="swal2-input w-full" placeholder="Stock" value="${i.stock}">
                </div>`,
                confirmButtonColor: '#4f46e5', confirmButtonText: 'Save', didOpen: renderImgs,
                preConfirm: () => {
                    const n = document.getElementById('i-n').value, p = document.getElementById('i-p').value;
                    if(!n || !p) return Swal.showValidationMessage('Name & Price Required');
                    return { id: isEdit ? i.id : 'i_'+Date.now(), name: n, price: parseFloat(p), cost: parseFloat(document.getElementById('i-c').value)||0, stock: parseInt(document.getElementById('i-s').value)||0, imgs: [...app.ui.imgs] };
                }
            }).then(r => {
                if(r.isConfirmed) { if(isEdit) app.data.inv[idx] = r.value; else app.data.inv.push(r.value); save(); }
            });
        }

        function opts(idx, type) {
            Swal.fire({
                title: 'Actions', showDenyButton: true, showCancelButton: true, confirmButtonText: 'Edit', denyButtonText: 'Delete', confirmButtonColor: '#4f46e5', denyButtonColor: '#ef4444'
            }).then(r => {
                if(r.isConfirmed) openItemModal(idx);
                if(r.isDenied) { app.data.inv.splice(idx, 1); save(); }
            });
        }

        // --- IMAGES ---
        async function handleImg(inp) {
            if(inp.files) {
                for(let f of Array.from(inp.files).slice(0, 5 - app.ui.imgs.length)) {
                    app.ui.imgs.push(await resize(f));
                }
                renderImgs();
            }
        }
        function resize(f) {
            return new Promise(r => {
                const rd = new FileReader();
                rd.onload = e => { const i = new Image(); i.onload = () => {
                    const c = document.createElement('canvas');
                    let w = i.width, h = i.height; if(w>300){h*=300/w;w=300;} c.width=w; c.height=h;
                    c.getContext('2d').drawImage(i,0,0,w,h); r(c.toDataURL('image/jpeg',0.6));
                }; i.src = e.target.result; }; rd.readAsDataURL(f);
            });
        }
        function renderImgs() {
            document.getElementById('swal-img-prev').innerHTML = app.ui.imgs.map((s,i) => `<div class="relative w-16 h-16 flex-shrink-0"><img src="${s}" class="w-full h-full rounded border"><button onclick="rmImg(${i})" class="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded text-[10px]">X</button></div>`).join('');
        }
        window.rmImg = i => { app.ui.imgs.splice(i,1); renderImgs(); };

        // --- BILLING ---
        function generateBill() {
            if(app.data.cart.length === 0) return;
            const cName = document.getElementById('c-name').value || 'Cash Customer';
            const cAddr = document.getElementById('c-addr').value || '';
            const cPhone = document.getElementById('c-phone').value || '';
            
            // Fill Preview
            document.getElementById('inv-shop').innerText = app.data.sets.name;
            document.getElementById('inv-addr').innerText = app.data.sets.addr;
            document.getElementById('inv-id').innerText = app.data.count;
            document.getElementById('inv-date').innerText = new Date().toLocaleDateString();
            document.getElementById('inv-client').innerText = cName;
            document.getElementById('inv-client-addr').innerText = cAddr + (cPhone ? '\n' + cPhone : '');
            
            let tot = 0;
            document.getElementById('inv-body').innerHTML = app.data.cart.map(c => {
                tot += c.price * c.qty;
                return `<tr><td class="py-2"><div class="font-bold text-slate-700">${c.name}</div><div class="text-[10px] text-slate-400">${c.desc||''}</div></td><td class="text-center py-2 text-slate-600">${c.qty}</td><td class="text-right py-2 text-slate-600">${c.price}</td><td class="text-right py-2 font-bold text-slate-800">${(c.price*c.qty).toFixed(2)}</td></tr>`;
            }).join('');
            
            document.getElementById('inv-total').innerText = tot.toFixed(2);
            document.getElementById('inv-note').innerText = app.data.sets.note;
            document.getElementById('inv-sign').innerHTML = app.data.sets.sign ? `<img src="${app.data.sets.sign}" class="h-full object-contain">` : '';

            document.getElementById('preview-modal').classList.remove('hidden');
            document.getElementById('inv-actions-new').classList.remove('hidden');
            document.getElementById('inv-actions-hist').classList.add('hidden');
        }

        function closePreview() { document.getElementById('preview-modal').classList.add('hidden'); }

        function finishBill(dl) {
            const tot = app.data.cart.reduce((a,b)=>a+b.price*b.qty,0);
            const rec = {
                id: app.data.count, date: new Date().toLocaleDateString(),
                client: document.getElementById('c-name').value || 'Cash Customer',
                addr: document.getElementById('c-addr').value, phone: document.getElementById('c-phone').value,
                total: tot, items: JSON.parse(JSON.stringify(app.data.cart))
            };
            
            // Stock
            rec.items.forEach(c => { if(!c.isManual){ const i = app.data.inv.find(x=>x.id===c.id); if(i) i.stock = Math.max(0, i.stock - c.qty); }});
            
            app.data.hist.unshift(rec); app.data.count++; app.data.cart = [];
            document.getElementById('c-name').value = ''; document.getElementById('c-addr').value = ''; document.getElementById('c-phone').value = '';
            save(); closePreview();
            
            if(dl) downloadInvoice();
            else toast('Bill Saved');
        }

        function downloadInvoice() {
            // Need to temporarily show the modal content clearly or clone it
            const el = document.getElementById('invoice-paper');
            html2canvas(el, { scale: 2 }).then(cvs => {
                const a = document.createElement('a'); a.download = `Inv_${document.getElementById('inv-id').innerText}.png`;
                a.href = cvs.toDataURL(); a.click();
            });
        }

        // --- HISTORY & ANALYTICS ---
        function renderHist() {
            const div = document.getElementById('hist-list');
            const term = document.getElementById('hist-search').value.toLowerCase();
            const view = document.getElementById('btn-h-club').classList.contains('text-primary') ? 'club' : 'all';
            
            if(app.data.hist.length === 0) { div.innerHTML = `<div class="text-center py-10 opacity-50">No History</div>`; return; }

            const filtered = app.data.hist.filter(h => h.client.toLowerCase().includes(term) || h.id.toString().includes(term));

            if(view === 'all') {
                div.innerHTML = filtered.map(h => `
                <div onclick="loadHist(${h.id})" class="bg-surface p-4 rounded-xl shadow-card border border-slate-100 flex justify-between items-center cursor-pointer hover:bg-slate-50">
                    <div><div class="font-bold text-slate-800">#${h.id} • ${h.client}</div><div class="text-xs text-slate-500">${h.date} • ${h.items.length} Items</div></div>
                    <div class="font-bold text-primary">₹${h.total.toFixed(2)}</div>
                </div>`).join('');
            } else {
                const groups = {};
                filtered.forEach(h => { const k = h.client+h.addr; if(!groups[k]) groups[k]={n:h.client, a:h.addr, b:[], t:0}; groups[k].b.push(h); groups[k].t+=h.total; });
                div.innerHTML = Object.values(groups).map(g => `
                <div class="bg-surface rounded-xl shadow-card border border-slate-100 overflow-hidden">
                    <div class="p-3 bg-slate-50 flex justify-between items-center border-b border-slate-100">
                        <div><div class="font-bold text-slate-800 text-sm">${g.n}</div><div class="text-[10px] text-slate-500">${g.a||''}</div></div>
                        <div class="text-right"><div class="font-bold text-primary text-sm">₹${g.t.toFixed(2)}</div><div class="text-[10px] text-slate-500">${g.b.length} Bills</div></div>
                    </div>
                    <div class="divide-y divide-slate-50">${g.b.map(b => `<div onclick="loadHist(${b.id})" class="p-2 pl-4 flex justify-between hover:bg-slate-50 cursor-pointer"><span class="text-xs text-slate-600">#${b.id} - ${b.date}</span><span class="text-xs font-bold text-slate-700">₹${b.total.toFixed(2)}</span></div>`).join('')}</div>
                </div>`).join('');
            }
        }

        function toggleHist(v) {
            document.getElementById('btn-h-all').className = v==='all' ? 'flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white shadow-sm text-primary' : 'flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-500 hover:bg-white/50';
            document.getElementById('btn-h-club').className = v==='club' ? 'flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white shadow-sm text-primary' : 'flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-500 hover:bg-white/50';
            renderHist();
        }

        function loadHist(id) {
            const h = app.data.hist.find(x => x.id === id);
            document.getElementById('inv-shop').innerText = app.data.sets.name;
            document.getElementById('inv-addr').innerText = app.data.sets.addr;
            document.getElementById('inv-id').innerText = h.id;
            document.getElementById('inv-date').innerText = h.date;
            document.getElementById('inv-client').innerText = h.client;
            document.getElementById('inv-client-addr').innerText = h.addr;
            document.getElementById('inv-body').innerHTML = h.items.map(c => `<tr><td class="py-2"><div class="font-bold text-slate-700">${c.name}</div></td><td class="text-center py-2 text-slate-600">${c.qty}</td><td class="text-right py-2 text-slate-600">${c.price}</td><td class="text-right py-2 font-bold text-slate-800">${(c.price*c.qty).toFixed(2)}</td></tr>`).join('');
            document.getElementById('inv-total').innerText = h.total.toFixed(2);
            document.getElementById('inv-note').innerText = app.data.sets.note;
            document.getElementById('inv-sign').innerHTML = app.data.sets.sign ? `<img src="${app.data.sets.sign}" class="h-full object-contain">` : '';
            
            document.getElementById('preview-modal').classList.remove('hidden');
            document.getElementById('inv-actions-new').classList.add('hidden');
            document.getElementById('inv-actions-hist').classList.remove('hidden');
        }

        function renderAnalytics() {
            let rev=0, cost=0, asset=0, pot=0;
            app.data.hist.forEach(h => h.items.forEach(i => { rev+=i.price*i.qty; cost+=(i.cost||0)*i.qty; }));
            app.data.inv.forEach(i => { asset+=(i.cost||0)*i.stock; pot+=i.price*i.stock; });
            const prof = rev-cost; const mar = rev>0?((prof/rev)*100).toFixed(1):0;
            document.getElementById('an-rev').innerText='₹'+rev.toLocaleString(); document.getElementById('an-cost').innerText='₹'+cost.toLocaleString();
            document.getElementById('an-profit').innerText='₹'+prof.toLocaleString(); document.getElementById('an-margin').innerText=mar+'%';
            document.getElementById('an-asset').innerText='₹'+asset.toLocaleString(); document.getElementById('an-pot').innerText='₹'+pot.toLocaleString();
        }

        // --- SETTINGS ---
        function updateSettingsUI() {
            const m = document.getElementById('tog-man'); const b = document.getElementById('manual-btn-area');
            m.className = app.data.sets.showMan ? "w-11 h-6 bg-primary rounded-full relative cursor-pointer transition-colors" : "w-11 h-6 bg-slate-300 rounded-full relative cursor-pointer transition-colors";
            m.firstElementChild.className = app.data.sets.showMan ? "w-4 h-4 bg-white rounded-full absolute top-1 right-1 transition-all shadow-sm" : "w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-all shadow-sm";
            b.style.display = app.data.sets.showMan ? 'block' : 'none';
            document.getElementById('sidebar-shop').innerText = app.data.sets.name;
        }

        function toggleManualBtn() { app.data.sets.showMan = !app.data.sets.showMan; save(); updateSettingsUI(); }
        function editShopDetails() { Swal.fire({ title:'Details', html:`<input id="s-n" class="swal2-input" value="${app.data.sets.name}"><textarea id="s-a" class="swal2-textarea">${app.data.sets.addr}</textarea>`, preConfirm:()=>{return{name:document.getElementById('s-n').value, addr:document.getElementById('s-a').value}}}).then(r=>{if(r.isConfirmed){Object.assign(app.data.sets, r.value); save(); updateSettingsUI();}}); }
        function openSignature() { Swal.fire({ title:'Signature', html:`<canvas id="cvs" width="300" height="150" class="border rounded bg-slate-50"></canvas><div class="text-right mt-2"><button onclick="clsCvs()" class="text-xs text-red-500 font-bold">Clear</button></div>`, didOpen:initCvs, preConfirm:()=>document.getElementById('cvs').toDataURL()}).then(r=>{if(r.isConfirmed){app.data.sets.sign=r.value;save();}}); }
        function initCvs() { const c=document.getElementById('cvs'), x=c.getContext('2d'); let d=false; 
            const getPos=(e)=>{const r=c.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top}};
            const dr=(e)=>{if(!d)return;e.preventDefault();const p=getPos(e);x.lineTo(p.x,p.y);x.stroke();};
            const st=(e)=>{e.preventDefault();d=true;x.beginPath();const p=getPos(e);x.moveTo(p.x,p.y);};
            c.addEventListener('mousedown',st); c.addEventListener('mousemove',dr); window.addEventListener('mouseup',()=>d=false);
            c.addEventListener('touchstart',st); c.addEventListener('touchmove',dr); window.addEventListener('touchend',()=>d=false);
            window.clsCvs=()=>x.clearRect(0,0,300,150);
        }
        function startTour() {
            Swal.fire({ title:'Welcome!', text:'Manage Inventory, Create Bills, Track Profits.', icon:'info', confirmButtonText:'Let\'s Go' }).then(()=>{ app.data.sets.tourDone=true; save(); });
        }
        function resetApp() { Swal.fire({title:'Reset?', icon:'warning', showCancelButton:true, confirmButtonColor:'#ef4444'}).then(r=>{if(r.isConfirmed){localStorage.clear(); location.reload();}})}
        function toast(m) { const t=Swal.mixin({toast:true, position:'bottom-end', showConfirmButton:false, timer:1500}); t.fire({icon:'success', title:m}); }
    </script>
</body>
</html>